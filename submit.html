<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Buat Laporan â€“ LaporIn</title>
    <meta name="description"
        content="Laporkan masalah di sekitar Anda â€” jalan rusak, sungai kotor, sampah menumpuk, dan lainnya." />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“¢</text></svg>" />
</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">
            <div class="logo-icon">ğŸ“¢</div>LaporIn
        </a>
        <ul class="navbar-nav">
            <li><a href="feed.html">Semua Laporan</a></li>
            <li><a href="submit.html" class="active">Buat Laporan</a></li>
            <li><a href="dashboard.html">Dashboard Pemerintah</a></li>
        </ul>
        <div class="navbar-actions">
            <a href="submit.html" class="btn btn-primary">ğŸ“¸ Laporkan Sekarang</a>
        </div>
    </nav>

    <div class="page-content">
        <div class="container-sm">
            <div class="text-center mb-8">
                <div class="section-tag">Buat Laporan</div>
                <h1 style="font-size: 2rem; font-weight: 800; margin-bottom: 8px;">Laporkan Masalah di Sekitarmu</h1>
                <p style="color: var(--gray-500);">Isi form di bawah ini. Selesai dalam kurang dari 2 menit!</p>
            </div>

            <!-- Progress Bar -->
            <div
                style="background: var(--gray-200); border-radius: 100px; height: 8px; margin-bottom: 32px; overflow: hidden;">
                <div id="progressBar"
                    style="background: linear-gradient(90deg, var(--red), var(--red-light)); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 100px;">
                </div>
            </div>

            <!-- Step indicators -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 32px;" id="stepIndicators">
                <div class="step-ind active" data-step="1">
                    <div
                        style="width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; background: var(--red); color: white; margin: 0 auto 4px;">
                        1</div>
                    <div style="font-size: 0.72rem; color: var(--gray-500); text-align:center;">Foto</div>
                </div>
                <div style="flex: 1; height: 2px; background: var(--gray-200); margin: 14px 8px 0;"></div>
                <div class="step-ind" data-step="2">
                    <div
                        style="width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; background: var(--gray-300); color: white; margin: 0 auto 4px; transition: all 0.3s;">
                        2</div>
                    <div style="font-size: 0.72rem; color: var(--gray-500); text-align:center;">Kategori</div>
                </div>
                <div style="flex: 1; height: 2px; background: var(--gray-200); margin: 14px 8px 0;"></div>
                <div class="step-ind" data-step="3">
                    <div
                        style="width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; background: var(--gray-300); color: white; margin: 0 auto 4px; transition: all 0.3s;">
                        3</div>
                    <div style="font-size: 0.72rem; color: var(--gray-500); text-align:center;">Detail</div>
                </div>
                <div style="flex: 1; height: 2px; background: var(--gray-200); margin: 14px 8px 0;"></div>
                <div class="step-ind" data-step="4">
                    <div
                        style="width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; background: var(--gray-300); color: white; margin: 0 auto 4px; transition: all 0.3s;">
                        4</div>
                    <div style="font-size: 0.72rem; color: var(--gray-500); text-align:center;">Lokasi</div>
                </div>
            </div>

            <form id="submitForm">

                <!-- STEP 1: Photo -->
                <div class="step-panel card" id="step1" style="padding: 32px;">
                    <h2 style="font-size: 1.2rem; font-weight: 700; margin-bottom: 20px;">ğŸ“¸ Step 1: Ambil atau Upload
                        Foto</h2>
                    <div class="photo-upload" id="photoUpload" onclick="document.getElementById('photoInput').click()">
                        <input type="file" id="photoInput" accept="image/*" capture="environment"
                            onchange="previewPhoto(event)" />
                        <div id="uploadPrompt">
                            <div class="photo-upload-icon">ğŸ“·</div>
                            <div style="font-weight: 700; font-size: 1rem; margin-bottom: 6px;">Klik untuk ambil foto
                                atau upload gambar</div>
                            <div style="font-size: 0.85rem; color: var(--gray-500);">Foto yang jelas akan mempercepat
                                penyelesaian masalah</div>
                        </div>
                        <img id="photoPreview" class="photo-preview" alt="Preview foto" />
                    </div>
                    <div
                        style="margin-top: 12px; padding: 12px 16px; background: #FEF3C7; border-radius: var(--radius-sm); font-size: 0.82rem; color: #92400E;">
                        ğŸ’¡ <strong>Tips:</strong> Pastikan foto jelas dan menunjukkan masalah dengan baik. Hindari foto
                        yang buram atau terlalu jauh.
                    </div>
                    <button type="button" class="btn btn-primary w-full" style="margin-top: 20px;"
                        onclick="nextStep(2)">Lanjutkan â†’</button>
                </div>

                <!-- STEP 2: Category -->
                <div class="step-panel card" id="step2" style="padding: 32px; display: none;">
                    <h2 style="font-size: 1.2rem; font-weight: 700; margin-bottom: 20px;">ğŸ“‚ Step 2: Pilih Kategori
                        Masalah</h2>
                    <div class="category-grid" id="categoryGrid"></div>
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button type="button" class="btn btn-ghost w-full" onclick="nextStep(1)">â† Kembali</button>
                        <button type="button" class="btn btn-primary w-full" onclick="nextStep(3)" id="step2Next"
                            disabled>Lanjutkan â†’</button>
                    </div>
                </div>

                <!-- STEP 3: Details -->
                <div class="step-panel card" id="step3" style="padding: 32px; display: none;">
                    <h2 style="font-size: 1.2rem; font-weight: 700; margin-bottom: 20px;">ğŸ“ Step 3: Ceritakan
                        Masalahnya</h2>
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label">Judul Laporan *</label>
                            <input type="text" class="form-control" id="reportTitle"
                                placeholder="Contoh: Jalan berlubang besar di Jl. Sudirman" required maxlength="100"
                                oninput="updateCharCount(this, 'titleCount', 100)" />
                            <div style="text-align: right; font-size: 0.75rem; color: var(--gray-400);"><span
                                    id="titleCount">0</span>/100</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Deskripsi Detail *</label>
                            <textarea class="form-control" id="reportDesc" rows="4"
                                placeholder="Jelaskan masalah ini secara detail. Berapa lama sudah terjadi? Apa dampaknya? Siapa yang terdampak?"
                                required maxlength="500" oninput="updateCharCount(this, 'descCount', 500)"></textarea>
                            <div style="text-align: right; font-size: 0.75rem; color: var(--gray-400);"><span
                                    id="descCount">0</span>/500</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nama Pelapor</label>
                            <input type="text" class="form-control" id="reporterName" placeholder="Anonim (opsional)" />
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button type="button" class="btn btn-ghost w-full" onclick="nextStep(2)">â† Kembali</button>
                        <button type="button" class="btn btn-primary w-full" onclick="nextStep(4)">Lanjutkan â†’</button>
                    </div>
                </div>

                <!-- STEP 4: Location -->
                <div class="step-panel card" id="step4" style="padding: 32px; display: none;">
                    <h2 style="font-size: 1.2rem; font-weight: 700; margin-bottom: 20px;">ğŸ“ Step 4: Konfirmasi Lokasi
                    </h2>
                    <div style="display: flex; gap: 12px; margin-bottom: 16px; align-items: flex-start;">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Alamat / Lokasi</label>
                            <input type="text" class="form-control" id="reportAddress"
                                placeholder="Contoh: Jl. Jenderal Sudirman No. 45, Jakarta Pusat" />
                        </div>
                        <button type="button" class="btn btn-secondary" style="margin-top: 26px; white-space: nowrap;"
                            onclick="detectLocation()">ğŸ“ Deteksi Otomatis</button>
                    </div>
                    <div id="locationMap"
                        style="height: 280px; border-radius: var(--radius); overflow: hidden; margin-bottom: 16px; background: var(--gray-200); display: flex; align-items: center; justify-content: center;">
                        <div id="mapPlaceholder" style="text-align: center; color: var(--gray-400);">
                            <div style="font-size: 2.5rem; margin-bottom: 8px;">ğŸ—ºï¸</div>
                            <div>Klik "Deteksi Otomatis" atau ketik alamat</div>
                        </div>
                    </div>
                    <div id="locationInfo"
                        style="display: none; padding: 12px 16px; background: #D1FAE5; border-radius: var(--radius-sm); font-size: 0.85rem; color: #065F46; margin-bottom: 16px;">
                        âœ… <span id="locationText">Lokasi terdeteksi</span>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button type="button" class="btn btn-ghost w-full" onclick="nextStep(3)">â† Kembali</button>
                        <button type="button" class="btn btn-green w-full" onclick="submitReport()">
                            ğŸš€ Kirim Laporan!
                        </button>
                    </div>
                </div>

            </form>

            <!-- Info boxes -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 24px;">
                <div
                    style="padding: 16px; background: white; border-radius: var(--radius); border: 1px solid var(--gray-200); font-size: 0.82rem;">
                    <div style="font-weight: 700; margin-bottom: 4px;">ğŸ”’ Privasi Anda Terjaga</div>
                    <div style="color: var(--gray-500);">Anda dapat melaporkan secara anonim. Data pribadi tidak akan
                        dipublikasikan.</div>
                </div>
                <div
                    style="padding: 16px; background: white; border-radius: var(--radius); border: 1px solid var(--gray-200); font-size: 0.82rem;">
                    <div style="font-weight: 700; margin-bottom: 4px;">âš¡ Respon Cepat</div>
                    <div style="color: var(--gray-500);">Pemerintah daerah akan dinotifikasi dalam hitungan menit
                        setelah laporan dikirim.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal-overlay" id="successModal">
        <div class="modal-box">
            <div class="modal-icon">ğŸ‰</div>
            <div class="modal-title">Laporan Berhasil Dikirim!</div>
            <div class="modal-body">
                Terima kasih telah berkontribusi untuk Indonesia yang lebih baik. Laporan Anda akan kami teruskan ke
                dinas terkait.
                <br><br>
                <strong>Kamu baru saja mendapatkan badge: ğŸŒŸ Superhero Warga!</strong>
            </div>
            <div id="reportId" style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 20px;"></div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-ghost w-full" onclick="shareWhatsApp()">ğŸ“± Bagikan ke WhatsApp</button>
                <a href="feed.html" class="btn btn-primary w-full">Lihat Semua Laporan</a>
            </div>
        </div>
    </div>

    <script src="js/data.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        initData();
        let currentStep = 1;
        let selectedCategory = null;
        let reportLat = -6.2088, reportLng = 106.8456;
        let locationMap = null;

        // Build category grid
        const catGrid = document.getElementById('categoryGrid');
        catGrid.innerHTML = CATEGORIES.map(c => `
    <div class="category-item" onclick="selectCategory('${c.id}', this)" id="cat-${c.id}">
      <div class="cat-icon">${c.icon}</div>
      <div class="cat-label">${c.label}</div>
    </div>`).join('');

        function selectCategory(id, el) {
            document.querySelectorAll('.category-item').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            selectedCategory = id;
            document.getElementById('step2Next').disabled = false;
        }

        function updateCharCount(el, countId, max) {
            document.getElementById(countId).textContent = el.value.length;
        }

        function previewPhoto(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const preview = document.getElementById('photoPreview');
                preview.src = ev.target.result;
                preview.style.display = 'block';
                document.getElementById('uploadPrompt').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        function nextStep(n) {
            // Validate current
            if (currentStep === 3) {
                const title = document.getElementById('reportTitle').value.trim();
                const desc = document.getElementById('reportDesc').value.trim();
                if (!title || !desc) {
                    alert('Harap isi judul dan deskripsi laporan!');
                    return;
                }
            }
            document.getElementById('step' + currentStep).style.display = 'none';
            document.getElementById('step' + n).style.display = 'block';
            currentStep = n;

            // Update progress bar
            const progress = ((n - 1) / 3) * 100;
            document.getElementById('progressBar').style.width = progress + '%';

            // Update step indicators
            document.querySelectorAll('.step-ind div:first-child').forEach((d, i) => {
                const stepNum = i + 1;
                if (stepNum < n) { d.style.background = 'var(--green)'; d.textContent = 'âœ“'; }
                else if (stepNum === n) { d.style.background = 'var(--red)'; d.textContent = stepNum; }
                else { d.style.background = 'var(--gray-300)'; d.textContent = stepNum; }
            });

            if (n === 4) initMap();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function initMap() {
            if (locationMap) return;
            const container = document.getElementById('locationMap');
            container.innerHTML = '';
            locationMap = L.map('locationMap').setView([reportLat, reportLng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(locationMap);
            L.marker([reportLat, reportLng]).addTo(locationMap).bindPopup('Lokasi laporan Anda').openPopup();
            locationMap.on('click', e => {
                reportLat = e.latlng.lat; reportLng = e.latlng.lng;
                locationMap.eachLayer(l => { if (l instanceof L.Marker) locationMap.removeLayer(l); });
                L.marker([reportLat, reportLng]).addTo(locationMap);
                document.getElementById('locationInfo').style.display = 'block';
                document.getElementById('locationText').textContent = `Lat: ${reportLat.toFixed(4)}, Lng: ${reportLng.toFixed(4)}`;
            });
        }

        function detectLocation() {
            if (!navigator.geolocation) {
                alert('Geolokasi tidak didukung browser ini.');
                return;
            }
            navigator.geolocation.getCurrentPosition(pos => {
                reportLat = pos.coords.latitude; reportLng = pos.coords.longitude;
                if (locationMap) {
                    locationMap.setView([reportLat, reportLng], 15);
                    locationMap.eachLayer(l => { if (l instanceof L.Marker) locationMap.removeLayer(l); });
                    L.marker([reportLat, reportLng]).addTo(locationMap).bindPopup('Lokasi Anda').openPopup();
                } else initMap();
                document.getElementById('locationInfo').style.display = 'block';
                document.getElementById('locationText').textContent = `Lokasi berhasil dideteksi (${reportLat.toFixed(4)}, ${reportLng.toFixed(4)})`;
                document.getElementById('reportAddress').value = `Lat: ${reportLat.toFixed(4)}, Lng: ${reportLng.toFixed(4)}`;
            }, () => {
                // Fallback to Jakarta
                document.getElementById('locationInfo').style.display = 'block';
                document.getElementById('locationText').textContent = 'Menggunakan lokasi demo: Jakarta Pusat';
            });
        }

        function submitReport() {
            const title = document.getElementById('reportTitle').value.trim();
            const desc = document.getElementById('reportDesc').value.trim();
            if (!title || !desc) { nextStep(3); return; }
            if (!selectedCategory) { nextStep(2); return; }

            const newId = 'RPT-' + String(Math.floor(Math.random() * 9000) + 1000);
            const newReport = {
                id: newId,
                title,
                description: desc,
                category: selectedCategory,
                status: 'dilaporkan',
                city: 'Jakarta',
                district: 'Jakarta Pusat',
                address: document.getElementById('reportAddress').value || 'Lokasi tidak ditentukan',
                lat: reportLat, lng: reportLng,
                upvotes: 1,
                upvotedBy: ['me'],
                reporter: document.getElementById('reporterName').value || 'Anonim',
                reporterBadge: 'Superhero Warga',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                department: null,
                photo: 'https://images.unsplash.com/photo-1515162305285-0293e4767cc2?w=600&q=80',
                comments: [],
                timeline: [{ status: 'dilaporkan', date: new Date().toISOString(), note: 'Laporan diterima oleh sistem LaporIn' }],
            };

            const reports = loadReports();
            reports.unshift(newReport);
            saveReports(reports);

            document.getElementById('reportId').textContent = `ID Laporan: ${newId}`;
            document.getElementById('successModal').classList.add('open');
            document.getElementById('progressBar').style.width = '100%';
        }

        function shareWhatsApp() {
            const text = encodeURIComponent(`Saya baru saja melaporkan masalah di LaporIn! ğŸ“¢\n\nMasalah: ${document.getElementById('reportTitle').value}\n\nBantu upvote dan pantau progressnya di: ${window.location.origin}/laporan/feed.html\n\nBersama kita bisa! ğŸ‡®ğŸ‡©`);
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }
    </script>
</body>

</html>