<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Pemerintah – LaporIn</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'></text></svg>" />
</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">
            <div class="logo-icon"></div>LaporIn
        </a>
        <ul class="navbar-nav">
            <li><a href="feed.html">Semua Laporan</a></li>
            <li><a href="submit.html">Buat Laporan</a></li>
            <li><a href="dashboard.html" class="active">Dashboard Pemerintah</a></li>
        </ul>
        <div class="navbar-actions">
            <span style="font-size: 0.85rem; color: var(--gray-500);">Selamat datang, <strong>Admin DKI
                    Jakarta</strong></span>
            <div
                style="width: 36px; height: 36px; border-radius: 50%; background: var(--red); display: flex; align-items: center; justify-content: center; color: white; font-weight: 800;">
                A</div>
        </div>
    </nav>

    <div class="page-content">
        <div style="display: grid; grid-template-columns: 240px 1fr; min-height: calc(100vh - 88px);">

            <!-- Sidebar -->
            <div class="sidebar" style="padding-top: 24px;">
                <div style="padding: 0 8px; margin-bottom: 24px;">
                    <div
                        style="font-size: 0.75rem; font-weight: 700; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 8px;">
                        NAVIGASI</div>
                </div>
                <div class="sidebar-nav">
                    <div class="sidebar-link active" onclick="showView('overview')">
                        <span class="link-icon"></span> Ringkasan
                    </div>
                    <div class="sidebar-link" onclick="showView('reports')">
                        <span class="link-icon"></span> Kelola Laporan
                    </div>
                    <div class="sidebar-link" onclick="showView('map')">
                        <span class="link-icon"></span> Peta Heatmap
                    </div>
                    <div class="sidebar-link" onclick="showView('analytics')">
                        <span class="link-icon"></span> Analitik
                    </div>
                    <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 16px 0;"></div>
                    <div
                        style="padding: 8px 14px; font-size: 0.75rem; font-weight: 700; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.1em;">
                        Akun</div>
                    <div class="sidebar-link" onclick="alert('Fitur notifikasi akan segera hadir!')">
                        <span class="link-icon"></span> Notifikasi <span
                            style="background: var(--red); color: white; padding: 2px 8px; border-radius: 100px; font-size: 0.7rem; margin-left: auto;"
                            id="notifBadge">0</span>
                    </div>
                    <div class="sidebar-link" onclick="alert('Fitur pengaturan akan segera hadir!')">
                        <span class="link-icon"></span> Pengaturan
                    </div>
                    <a href="index.html" class="sidebar-link">
                        <span class="link-icon"></span> Situs Publik
                    </a>
                </div>
            </div>

            <!-- Main Content -->
            <div id="dashMain" style="padding: 32px; background: var(--gray-50); overflow-y: auto;">

                <!-- ===== OVERVIEW VIEW ===== -->
                <div id="viewOverview">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px;">
                        <div>
                            <h1 style="font-size: 1.6rem; font-weight: 800;"> Ringkasan Dashboard</h1>
                            <p style="color: var(--gray-500); margin-top: 4px; font-size: 0.88rem;">Data real-time
                                laporan warga DKI Jakarta</p>
                        </div>
                        <div style="text-align: right; font-size: 0.82rem; color: var(--gray-400);">
                            Terakhir diperbarui: <strong id="lastUpdated"></strong>
                        </div>
                    </div>

                    <!-- Stats Row -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px;">
                        <div class="dash-stat">
                            <div class="dash-stat-icon" style="background: #FEE2E2;"></div>
                            <div>
                                <div class="dash-stat-num" id="dTotal">0</div>
                                <div class="dash-stat-label">Total Laporan</div>
                            </div>
                        </div>
                        <div class="dash-stat">
                            <div class="dash-stat-icon" style="background: #FEF3C7;"></div>
                            <div>
                                <div class="dash-stat-num" id="dPending">0</div>
                                <div class="dash-stat-label">Menunggu Tindakan</div>
                            </div>
                        </div>
                        <div class="dash-stat">
                            <div class="dash-stat-icon" style="background: #DBEAFE;"></div>
                            <div>
                                <div class="dash-stat-num" id="dInProgress">0</div>
                                <div class="dash-stat-label">Sedang Diproses</div>
                            </div>
                        </div>
                        <div class="dash-stat">
                            <div class="dash-stat-icon" style="background: #D1FAE5;"></div>
                            <div>
                                <div class="dash-stat-num" id="dResolved">0</div>
                                <div class="dash-stat-label">Selesai</div>
                            </div>
                        </div>
                    </div>

                    <!-- Second stats row -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 28px;">
                        <div class="dash-stat">
                            <div class="dash-stat-icon" style="background: #F3E8FF;"></div>
                            <div>
                                <div class="dash-stat-num" id="dTopUpvotes">0</div>
                                <div class="dash-stat-label">Total Dukungan Warga</div>
                            </div>
                        </div>
                        <div class="dash-stat">
                            <div class="dash-stat-icon" style="background: #FFF7ED;"></div>
                            <div>
                                <div class="dash-stat-num">4.2</div>
                                <div class="dash-stat-label">Rata-rata Waktu Respons (hari)</div>
                            </div>
                        </div>
                        <div class="dash-stat">
                            <div class="dash-stat-icon" style="background: #ECFDF5;"></div>
                            <div>
                                <div class="dash-stat-num" id="dResolutionRate">0%</div>
                                <div class="dash-stat-label">Tingkat Penyelesaian</div>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">

                        <!-- Recent reports needing action -->
                        <div class="card" style="padding: 20px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="font-size: 1rem; font-weight: 700;"> Perlu Tindakan Segera</h3>
                                <button class="btn btn-ghost btn-sm" onclick="showView('reports')">Lihat Semua</button>
                            </div>
                            <div id="urgentList"></div>
                        </div>

                        <!-- Category breakdown -->
                        <div class="card" style="padding: 20px;">
                            <h3 style="font-size: 1rem; font-weight: 700; margin-bottom: 16px;"> Laporan per Kategori
                            </h3>
                            <div id="categoryBreakdown"></div>
                        </div>

                    </div>
                </div>

                <!-- ===== REPORTS VIEW ===== -->
                <div id="viewReports" style="display: none;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                        <h1 style="font-size: 1.6rem; font-weight: 800;"> Kelola Laporan</h1>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <select class="sort-select" id="dashStatusFilter" onchange="renderTable()">
                                <option value="all">Semua Status</option>
                                <option value="dilaporkan"> Dilaporkan</option>
                                <option value="diverifikasi"> Diverifikasi</option>
                                <option value="diproses"> Diproses</option>
                                <option value="selesai"> Selesai</option>
                            </select>
                            <select class="sort-select" id="dashCatFilter" onchange="renderTable()">
                                <option value="all">Semua Kategori</option>
                            </select>
                        </div>
                    </div>
                    <div class="card" style="overflow: hidden;">
                        <div style="overflow-x: auto;">
                            <table class="data-table" id="reportsTable">
                                <thead>
                                    <tr>
                                        <th>LAPORAN</th>
                                        <th>KATEGORI</th>
                                        <th>KOTA</th>
                                        <th>DUKUNGAN</th>
                                        <th>STATUS</th>
                                        <th>TANGGAL</th>
                                        <th>AKSI</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ===== MAP VIEW ===== -->
                <div id="viewMap" style="display: none;">
                    <h1 style="font-size: 1.6rem; font-weight: 800; margin-bottom: 24px;"> Peta Heatmap Masalah</h1>
                    <div class="card" style="overflow: hidden;">
                        <div id="dashMap" style="height: 550px;"></div>
                    </div>
                    <div style="display: flex; gap: 16px; margin-top: 16px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
                            <div style="width: 16px; height: 16px; border-radius: 50%; background: var(--red);"></div>
                            Dilaporkan
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
                            <div style="width: 16px; height: 16px; border-radius: 50%; background: var(--yellow);">
                            </div> Diverifikasi
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
                            <div style="width: 16px; height: 16px; border-radius: 50%; background: var(--blue);"></div>
                            Diproses
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
                            <div style="width: 16px; height: 16px; border-radius: 50%; background: var(--green);"></div>
                            Selesai
                        </div>
                    </div>
                </div>

                <!-- ===== ANALYTICS VIEW ===== -->
                <div id="viewAnalytics" style="display: none;">
                    <h1 style="font-size: 1.6rem; font-weight: 800; margin-bottom: 24px;"> Analitik Kinerja</h1>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <div class="card" style="padding: 24px;">
                            <h3 style="font-weight: 700; margin-bottom: 16px;"> Kota Paling Aktif</h3>
                            <div id="cityStats"></div>
                        </div>
                        <div class="card" style="padding: 24px;">
                            <h3 style="font-weight: 700; margin-bottom: 16px;"> Masalah Terbanyak</h3>
                            <div id="catStats"></div>
                        </div>
                        <div class="card" style="padding: 24px; grid-column: 1 / -1;">
                            <h3 style="font-weight: 700; margin-bottom: 16px;"> Warga Paling Aktif</h3>
                            <div id="wargaStats"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Update Status Modal -->
    <div class="modal-overlay" id="statusModal">
        <div class="modal-box" style="text-align: left;">
            <h3 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 4px;" id="modalReportTitle"></h3>
            <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 20px;" id="modalReportId"></p>
            <div class="form-group mb-4">
                <label class="form-label">Status Baru</label>
                <select class="form-control" id="newStatusSelect">
                    <option value="dilaporkan"> Dilaporkan</option>
                    <option value="diverifikasi"> Diverifikasi</option>
                    <option value="diproses"> Sedang Diproses</option>
                    <option value="selesai"> Selesai</option>
                </select>
            </div>
            <div class="form-group mb-4">
                <label class="form-label">Dinas yang Ditugaskan</label>
                <select class="form-control" id="deptSelect">
                    <option value="">Pilih Dinas...</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">Catatan Update</label>
                <textarea class="form-control" id="updateNote" rows="3"
                    placeholder="Jelaskan tindakan yang sudah/akan diambil..."></textarea>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-ghost w-full" onclick="closeModal()">Batal</button>
                <button class="btn btn-primary w-full" onclick="saveStatus()">Simpan Update</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <div class="toast-icon"></div>
        <div>
            <div class="toast-title" id="toastTitle"></div>
            <div class="toast-body" id="toastBody"></div>
        </div>
    </div>

    <script src="js/data.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let selectedReportId = null;
        let allReports = [];
        let dashMap = null;

        // Populate dept select
        const deptSel = document.getElementById('deptSelect');
        DEPARTMENTS.forEach(d => { const o = document.createElement('option'); o.value = d; o.textContent = d; deptSel.appendChild(o); });

        // Populate category filter in table view
        const dashCatFilter = document.getElementById('dashCatFilter');
        CATEGORIES.forEach(c => { const o = document.createElement('option'); o.value = c.id; o.textContent = c.label; dashCatFilter.appendChild(o); });

        // Last updated
        document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

        function showView(view) {
            ['overview', 'reports', 'map', 'analytics'].forEach(v => {
                document.getElementById('view' + v.charAt(0).toUpperCase() + v.slice(1)).style.display = v === view ? 'block' : 'none';
            });
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if (view === 'reports') renderTable();
            if (view === 'map') initDashMap();
            if (view === 'analytics') renderAnalytics();
        }

        function renderOverview() {
            const reports = allReports;
            const total = reports.length;
            const pending = reports.filter(r => r.status === 'dilaporkan').length;
            const inProgress = reports.filter(r => r.status === 'diproses').length;
            const resolved = reports.filter(r => r.status === 'selesai').length;
            const totalUpvotes = reports.reduce((s, r) => s + r.upvotes, 0);
            const rate = total > 0 ? Math.round((resolved / total) * 100) : 0;

            document.getElementById('dTotal').textContent = total;
            document.getElementById('dPending').textContent = pending;
            document.getElementById('dInProgress').textContent = inProgress;
            document.getElementById('dResolved').textContent = resolved;
            document.getElementById('dTopUpvotes').textContent = totalUpvotes.toLocaleString('id-ID');
            document.getElementById('dResolutionRate').textContent = rate + '%';
            document.getElementById('notifBadge').textContent = pending + inProgress;

            const urgent = reports.filter(r => r.status !== 'selesai').sort((a, b) => b.upvotes - a.upvotes).slice(0, 4);
            document.getElementById('urgentList').innerHTML = urgent.map(r => {
                const cat = getCategory(r.category);
                const st = getStatus(r.status);
                return `
        <div style="display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--gray-100); cursor: pointer;" onclick="location.href='report.html?id=${r.id}'">
          <img src="${r.photo}" style="width: 44px; height: 44px; border-radius: 8px; object-fit: cover; flex-shrink: 0;" onerror="this.style.background='#eee';this.removeAttribute('src');" />
          <div style="flex: 1; min-width: 0;">
            <div style="font-size: 0.85rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${r.title}</div>
            <div style="font-size: 0.75rem; color: var(--gray-400);">${cat.label} · ${r.city} · ${r.upvotes} dukungan</div>
          </div>
          <span class="badge badge-${r.status}" style="flex-shrink: 0;">${st.label}</span>
        </div>`;
            }).join('');

            const catCounts = {};
            reports.forEach(r => { catCounts[r.category] = (catCounts[r.category] || 0) + 1; });
            const sorted = Object.entries(catCounts).sort((a, b) => b[1] - a[1]);
            document.getElementById('categoryBreakdown').innerHTML = sorted.map(([id, count]) => {
                const cat = getCategory(id);
                const pct = Math.round((count / total) * 100);
                return `
        <div style="margin-bottom: 14px;">
          <div style="display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 600; margin-bottom: 4px;">
            <span>${cat.label}</span>
            <span style="color: var(--gray-500);">${count} (${pct}%)</span>
          </div>
          <div style="background: var(--gray-200); border-radius: 100px; height: 8px; overflow: hidden;">
            <div style="background: linear-gradient(90deg, var(--red), var(--red-light)); height: 100%; width: ${pct}%; border-radius: 100px; transition: width 0.6s ease;"></div>
          </div>
        </div>`;
            }).join('');
        }

        function renderTable() {
            const statusFilter = document.getElementById('dashStatusFilter').value;
            const catFilter = document.getElementById('dashCatFilter').value;
            let reports = [...allReports];
            if (statusFilter !== 'all') reports = reports.filter(r => r.status === statusFilter);
            if (catFilter !== 'all') reports = reports.filter(r => r.category === catFilter);

            document.getElementById('tableBody').innerHTML = reports.map(r => {
                const cat = getCategory(r.category);
                const st = getStatus(r.status);
                return `
        <tr>
          <td>
            <div style="display: flex; align-items: center; gap: 10px;">
              <img src="${r.photo}" class="report-thumb" onerror="this.style.background='#eee';this.removeAttribute('src');" />
              <div>
                <div style="font-weight: 600; font-size: 0.88rem; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${r.title}</div>
                <div style="font-size: 0.75rem; color: var(--gray-400);">${r.id}</div>
              </div>
            </div>
          </td>
          <td><span class="badge badge-cat">${cat.label}</span></td>
          <td style="font-size: 0.85rem;">${r.city}</td>
          <td style="font-weight: 700; color: var(--red);">${r.upvotes}</td>
          <td><span class="badge badge-${r.status}">${st.label}</span></td>
          <td style="font-size: 0.8rem; color: var(--gray-500);">${formatDate(r.createdAt)}</td>
          <td>
            <div style="display: flex; gap: 6px;">
              <button class="btn btn-primary btn-sm" onclick="openUpdateModal('${r.id}')">Update</button>
              <a href="report.html?id=${r.id}" class="btn btn-ghost btn-sm">Detail</a>
            </div>
          </td>
        </tr>`;
            }).join('');
        }

        function openUpdateModal(id) {
            selectedReportId = id;
            const r = allReports.find(r => r.id === id);
            document.getElementById('modalReportTitle').textContent = r.title;
            document.getElementById('modalReportId').textContent = r.id + ' · ' + r.city;
            document.getElementById('newStatusSelect').value = r.status;
            document.getElementById('deptSelect').value = r.department || '';
            document.getElementById('updateNote').value = '';
            document.getElementById('statusModal').classList.add('open');
        }
        function closeModal() { document.getElementById('statusModal').classList.remove('open'); }

        async function saveStatus() {
            const newStatus = document.getElementById('newStatusSelect').value;
            const dept = document.getElementById('deptSelect').value;
            const note = document.getElementById('updateNote').value || 'Status diperbarui oleh admin';
            const btn = document.querySelector('#statusModal .btn-primary');
            btn.disabled = true;
            btn.textContent = 'Menyimpan...';
            try {
                const updated = await apiUpdateStatus(selectedReportId, newStatus, dept, note);
                // Update local cache
                const idx = allReports.findIndex(r => r.id === selectedReportId);
                if (idx !== -1) allReports[idx] = updated;
                closeModal();
                renderOverview();
                renderTable();
                showToast('Status berhasil diperbarui!', `${updated.title} → ${getStatus(newStatus).label}`);
            } catch {
                showToast('Gagal menyimpan', 'Coba lagi.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Simpan Update';
            }
        }

        function initDashMap() {
            if (dashMap) return;
            dashMap = L.map('dashMap').setView([-2.5, 118], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(dashMap);
            const colors = { dilaporkan: '#E63946', diverifikasi: '#F59E0B', diproses: '#3B82F6', selesai: '#2DC653' };
            allReports.forEach(r => {
                if (!r.lat || !r.lng) return;
                const cat = getCategory(r.category);
                const icon = L.divIcon({
                    html: `<div style="background:${colors[r.status] || '#E63946'};width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:0.75rem;font-weight:700;box-shadow:0 4px 12px rgba(0,0,0,0.3);border:3px solid white;">${cat.label[0]}</div>`,
                    className: '', iconSize: [36, 36], iconAnchor: [18, 18]
                });
                L.marker([r.lat, r.lng], { icon }).addTo(dashMap)
                    .bindPopup(`<strong>${r.title}</strong><br>${r.upvotes} dukungan · ${getStatus(r.status).label}<br><a href="report.html?id=${r.id}">Lihat Detail</a>`);
            });
        }

        function renderAnalytics() {
            const reports = allReports;
            const cities = {};
            reports.forEach(r => { cities[r.city] = (cities[r.city] || 0) + 1; });
            document.getElementById('cityStats').innerHTML = Object.entries(cities).sort((a, b) => b[1] - a[1]).map(([city, count]) => `
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--gray-100);">
        <span style="font-weight: 600;">${city}</span>
        <span style="font-weight: 800; color: var(--red);">${count} laporan</span>
      </div>`).join('');

            const cats = {};
            reports.forEach(r => { cats[r.category] = (cats[r.category] || 0) + 1; });
            document.getElementById('catStats').innerHTML = Object.entries(cats).sort((a, b) => b[1] - a[1]).map(([id, count]) => {
                const cat = getCategory(id);
                return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--gray-100);">
        <span style="font-weight: 600;">${cat.label}</span>
        <span style="font-weight: 800; color: var(--red);">${count}</span>
      </div>`;
            }).join('');

            document.getElementById('wargaStats').innerHTML = LEADERBOARD.map((u, i) => `
      <div style="display: flex; align-items: center; gap: 16px; padding: 12px 0; border-bottom: 1px solid var(--gray-100);">
        <span style="font-size: 1.5rem; font-weight: 800; width: 32px; text-align: center;">${i + 1}</span>
        <div style="flex: 1;">
          <div style="font-weight: 700;">${u.name}</div>
          <div style="font-size: 0.8rem; color: var(--gray-400);">${u.city} · ${u.badge}</div>
        </div>
        <div style="text-align: right;">
          <div style="font-weight: 800; color: var(--red);">${u.reports} laporan</div>
          <div style="font-size: 0.78rem; color: var(--yellow); font-weight: 700;">${u.points.toLocaleString('id-ID')} poin</div>
        </div>
      </div>`).join('');
        }

        function showToast(title, body) {
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastBody').textContent = body;
            const t = document.getElementById('toast');
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3500);
        }

        // Load data from API
        apiLoadReports().then(reports => {
            allReports = reports;
            renderOverview();
        }).catch(() => {
            document.getElementById('dTotal').textContent = 'ERR';
            showToast('Gagal memuat data', 'Pastikan server berjalan di port 3001.');
        });
    </script>
</body>

</html>


// Populate dept select
const deptSel = document.getElementById('deptSelect');
DEPARTMENTS.forEach(d => { const o = document.createElement('option'); o.value = d; o.textContent = d;
deptSel.appendChild(o); });

// Populate category filter in table view
const dashCatFilter = document.getElementById('dashCatFilter');
CATEGORIES.forEach(c => { const o = document.createElement('option'); o.value = c.id; o.textContent = `${c.icon}
${c.label}`; dashCatFilter.appendChild(o); });

// Last updated
document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute:
'2-digit' });

function showView(view) {
['overview', 'reports', 'map', 'analytics'].forEach(v => {
document.getElementById('view' + v.charAt(0).toUpperCase() + v.slice(1)).style.display = v === view ? 'block' : 'none';
});
document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
event.currentTarget.classList.add('active');
if (view === 'reports') renderTable();
if (view === 'map') initDashMap();
if (view === 'analytics') renderAnalytics();
}

function renderOverview() {
const reports = loadReports();
const total = reports.length;
const pending = reports.filter(r => r.status === 'dilaporkan').length;
const inProgress = reports.filter(r => r.status === 'diproses').length;
const resolved = reports.filter(r => r.status === 'selesai').length;
const totalUpvotes = reports.reduce((s, r) => s + r.upvotes, 0);
const rate = Math.round((resolved / total) * 100);

document.getElementById('dTotal').textContent = total;
document.getElementById('dPending').textContent = pending;
document.getElementById('dInProgress').textContent = inProgress;
document.getElementById('dResolved').textContent = resolved;
document.getElementById('dTopUpvotes').textContent = totalUpvotes.toLocaleString('id-ID');
document.getElementById('dResolutionRate').textContent = rate + '%';
document.getElementById('notifBadge').textContent = pending + inProgress;

// Urgent list
const urgent = reports.filter(r => r.status !== 'selesai').sort((a, b) => b.upvotes - a.upvotes).slice(0, 4);
document.getElementById('urgentList').innerHTML = urgent.map(r => {
const cat = getCategory(r.category);
const st = getStatus(r.status);
return `
<div style="display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--gray-100); cursor: pointer;"
    onclick="location.href='report.html?id=${r.id}'">
    <img src="${r.photo}" style="width: 44px; height: 44px; border-radius: 8px; object-fit: cover; flex-shrink: 0;"
        onerror="this.style.background='#eee';this.removeAttribute('src');" />
    <div style="flex: 1; min-width: 0;">
        <div
            style="font-size: 0.85rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            ${r.title}</div>
        <div style="font-size: 0.75rem; color: var(--gray-400);">${cat.icon} ${r.city} · ${r.upvotes}</div>
    </div>
    <span class="badge badge-${r.status}" style="flex-shrink: 0;">${st.label}</span>
</div>`;
}).join('');

// Category breakdown
const catCounts = {};
reports.forEach(r => { catCounts[r.category] = (catCounts[r.category] || 0) + 1; });
const sorted = Object.entries(catCounts).sort((a, b) => b[1] - a[1]);
document.getElementById('categoryBreakdown').innerHTML = sorted.map(([id, count]) => {
const cat = getCategory(id);
const pct = Math.round((count / total) * 100);
return `
<div style="margin-bottom: 14px;">
    <div
        style="display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 600; margin-bottom: 4px;">
        <span>${cat.icon} ${cat.label}</span>
        <span style="color: var(--gray-500);">${count} (${pct}%)</span>
    </div>
    <div style="background: var(--gray-200); border-radius: 100px; height: 8px; overflow: hidden;">
        <div
            style="background: linear-gradient(90deg, var(--red), var(--red-light)); height: 100%; width: ${pct}%; border-radius: 100px; transition: width 0.6s ease;">
        </div>
    </div>
</div>`;
}).join('');
}

function renderTable() {
const statusFilter = document.getElementById('dashStatusFilter').value;
const catFilter = document.getElementById('dashCatFilter').value;
let reports = loadReports();
if (statusFilter !== 'all') reports = reports.filter(r => r.status === statusFilter);
if (catFilter !== 'all') reports = reports.filter(r => r.category === catFilter);

document.getElementById('tableBody').innerHTML = reports.map(r => {
const cat = getCategory(r.category);
const st = getStatus(r.status);
return `
<tr>
    <td>
        <div style="display: flex; align-items: center; gap: 10px;">
            <img src="${r.photo}" class="report-thumb"
                onerror="this.style.background='#eee';this.removeAttribute('src');" />
            <div>
                <div
                    style="font-weight: 600; font-size: 0.88rem; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    ${r.title}</div>
                <div style="font-size: 0.75rem; color: var(--gray-400);">${r.id}</div>
            </div>
        </div>
    </td>
    <td><span class="badge badge-cat">${cat.icon} ${cat.label}</span></td>
    <td style="font-size: 0.85rem;"> ${r.city}</td>
    <td style="font-weight: 700; color: var(--red);"> ${r.upvotes}</td>
    <td><span class="badge badge-${r.status}">${st.icon} ${st.label}</span></td>
    <td style="font-size: 0.8rem; color: var(--gray-500);">${formatDate(r.createdAt)}</td>
    <td>
        <div style="display: flex; gap: 6px;">
            <button class="btn btn-primary btn-sm" onclick="openUpdateModal('${r.id}')">Update</button>
            <a href="report.html?id=${r.id}" class="btn btn-ghost btn-sm">Detail</a>
        </div>
    </td>
</tr>`;
}).join('');
}

function openUpdateModal(id) {
selectedReportId = id;
const reports = loadReports();
const r = reports.find(r => r.id === id);
document.getElementById('modalReportTitle').textContent = r.title;
document.getElementById('modalReportId').textContent = r.id + ' · ' + r.city;
document.getElementById('newStatusSelect').value = r.status;
document.getElementById('deptSelect').value = r.department || '';
document.getElementById('updateNote').value = '';
document.getElementById('statusModal').classList.add('open');
}
function closeModal() { document.getElementById('statusModal').classList.remove('open'); }

function saveStatus() {
const reports = loadReports();
const r = reports.find(r => r.id === selectedReportId);
const newStatus = document.getElementById('newStatusSelect').value;
const dept = document.getElementById('deptSelect').value;
const note = document.getElementById('updateNote').value || 'Status diperbarui oleh admin';
r.status = newStatus;
r.department = dept || r.department;
r.updatedAt = new Date().toISOString();
if (!r.timeline) r.timeline = [];
r.timeline.push({ status: newStatus, date: new Date().toISOString(), note });
saveReports(reports);
closeModal();
renderOverview();
renderTable();
showToast('Status berhasil diperbarui! ', `${r.title} → ${getStatus(newStatus).label}`);
}

function initDashMap() {
if (dashMap) return;
dashMap = L.map('dashMap').setView([-2.5, 118], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(dashMap);
const reports = loadReports();
const colors = { dilaporkan: '#E63946', diverifikasi: '#F59E0B', diproses: '#3B82F6', selesai: '#2DC653' };
reports.forEach(r => {
const cat = getCategory(r.category);
const icon = L.divIcon({
html: `<div
    style="background:${colors[r.status] || '#E63946'};width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:1rem;box-shadow:0 4px 12px rgba(0,0,0,0.3);border:3px solid white;">
    ${cat.icon}</div>`,
className: '', iconSize: [36, 36], iconAnchor: [18, 18]
});
L.marker([r.lat, r.lng], { icon }).addTo(dashMap)
.bindPopup(`<strong>${r.title}</strong><br> ${r.upvotes} · ${getStatus(r.status).label}<br><a
    href="report.html?id=${r.id}">Lihat Detail →</a>`);
});
}

function renderAnalytics() {
const reports = loadReports();
// City stats
const cities = {};
reports.forEach(r => { cities[r.city] = (cities[r.city] || 0) + 1; });
document.getElementById('cityStats').innerHTML = Object.entries(cities).sort((a, b) => b[1] - a[1]).map(([city, count])
=> `
<div
    style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--gray-100);">
    <span style="font-weight: 600;"> ${city}</span>
    <span style="font-weight: 800; color: var(--red);">${count} laporan</span>
</div>`).join('');

// Category stats
const cats = {};
reports.forEach(r => { cats[r.category] = (cats[r.category] || 0) + 1; });
document.getElementById('catStats').innerHTML = Object.entries(cats).sort((a, b) => b[1] - a[1]).map(([id, count]) => {
const cat = getCategory(id);
return `<div
    style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--gray-100);">
    <span style="font-weight: 600;">${cat.icon} ${cat.label}</span>
    <span style="font-weight: 800; color: var(--red);">${count}</span>
</div>`;
}).join('');

// Leaderboard
document.getElementById('wargaStats').innerHTML = LEADERBOARD.map((u, i) => `
<div style="display: flex; align-items: center; gap: 16px; padding: 12px 0; border-bottom: 1px solid var(--gray-100);">
    <span style="font-size: 1.5rem;">${['1', '2', '3', '4', '5'][i]}</span>
    <div style="flex: 1;">
        <div style="font-weight: 700;">${u.name}</div>
        <div style="font-size: 0.8rem; color: var(--gray-400);"> ${u.city} · ${u.badge}</div>
    </div>
    <div style="text-align: right;">
        <div style="font-weight: 800; color: var(--red);">${u.reports} laporan</div>
        <div style="font-size: 0.78rem; color: var(--yellow); font-weight: 700;">${u.points.toLocaleString('id-ID')}
            poin</div>
    </div>
</div>`).join('');
}

function showToast(title, body) {
document.getElementById('toastTitle').textContent = title;
document.getElementById('toastBody').textContent = body;
const t = document.getElementById('toast');
t.classList.add('show');
setTimeout(() => t.classList.remove('show'), 3500);
}

// Initial render
renderOverview();
</script>
</body>

</html>